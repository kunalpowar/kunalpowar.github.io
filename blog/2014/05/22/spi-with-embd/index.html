
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>SPI With EMBD - My how, why, what n where&#8230;</title>
  <meta name="author" content="Kunal Powar">

  
  <meta name="description" content="Once the mcp3008(a spi enabled 10-bit 8 channel ADC) was lost and found amoung our huge hardware heap i quickly started thinking about how to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kunalpowar.github.io/blog/2014/05/22/spi-with-embd/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My how, why, what n where..." type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My how, why, what n where&#8230;</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="kunalpowar.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">SPI With EMBD</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-22T09:52:03+05:30'><span class='date'><span class='date-month'>May</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>9:52 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Once the mcp3008(a spi enabled 10-bit 8 channel ADC) was lost and found amoung our huge hardware heap i quickly started thinking about how to implement SPI in golang and include it as the next communicaton protocol supported under <a href="http://embd.kidoman.io">EMBD</a>. I looked through the existing implementations for the same, so that the users wont be alien to the end-points the library would provide. There was one  interesting problem at hand. EMBD is written to support multiple boards. The core functionality of SPI remains same for all the linux based ones. But in case of beaglebone, one extra step had to be done. SPI is not enabled by default in a bbb. And we dont want users to load the specific dtc everytime it boots up. So the library itself has to handle initializing SPI behind the scenes. Does this mean that i need to write separate files with essentially the same code for bbb and rpi (currently supported boards)..? In the world of clean and DRY style of coding, that would be a horrendous crime. So after a long thought this came out as a viable solution. Every host simply tells the generic spi driver if anything has to be done before the core spi features are available. In this case bbb sends a initializer function to the driver and rpi sends nil. Once the SPI core was ready, writing a package for mcp3008 was a piece of cake, thanks to the awesomely detailed datasheet.</p>

<h3>Sample</h3>

<p>The following sample uses the mcp3008 package to get 10 bit Digital value of the analog input at 0th channel via SPI.</p>

<blockquote><p>This works <strong>without any code change</strong> on both beaglebone black and raspberypi</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;flag&quot;</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="s">&quot;github.com/kidoman/embd&quot;</span>
</span><span class='line'>  <span class="s">&quot;github.com/kidoman/embd/convertors/mcp3008&quot;</span>
</span><span class='line'>  <span class="nx">_</span> <span class="s">&quot;github.com/kidoman/embd/host/all&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">const</span> <span class="p">(</span>
</span><span class='line'>  <span class="nx">channel</span> <span class="p">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="nx">speed</span>   <span class="p">=</span> <span class="mi">1000000</span>
</span><span class='line'>  <span class="nx">bpw</span>     <span class="p">=</span> <span class="mi">8</span>
</span><span class='line'>  <span class="nx">delay</span>   <span class="p">=</span> <span class="mi">0</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;this is a sample code for mcp3008 10bit 8 channel ADC&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">embd</span><span class="p">.</span><span class="nx">InitSPI</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">defer</span> <span class="nx">embd</span><span class="p">.</span><span class="nx">CloseSPI</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">spiBus</span> <span class="o">:=</span> <span class="nx">embd</span><span class="p">.</span><span class="nx">NewSPIBus</span><span class="p">(</span><span class="nx">embd</span><span class="p">.</span><span class="nx">SPIMode0</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">bpw</span><span class="p">,</span> <span class="nx">delay</span><span class="p">)</span>
</span><span class='line'>  <span class="k">defer</span> <span class="nx">spiBus</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">adc</span> <span class="o">:=</span> <span class="nx">mcp3008</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">mcp3008</span><span class="p">.</span><span class="nx">SingleMode</span><span class="p">,</span> <span class="nx">spiBus</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">val</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">adc</span><span class="p">.</span><span class="nx">AnalogValueAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;analog value is: %v\n&quot;</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>TODOs</h3>

<ul>
<li>Cover all the modes for SPI</li>
<li>Provide support for the differential mode of operation for mcp3008</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Kunal Powar</span></span>

      




<time class='entry-date' datetime='2014-05-22T09:52:03+05:30'><span class='date'><span class='date-month'>May</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>9:52 am</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://kunalpowar.github.io/blog/2014/05/22/spi-with-embd/" data-via="" data-counturl="http://kunalpowar.github.io/blog/2014/05/22/spi-with-embd/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/05/19/hello-world-with-embd/" title="Previous Post: Hello world with EMBD">&laquo; Hello world with EMBD</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/22/spi-with-embd/">SPI With EMBD</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/19/hello-world-with-embd/">Hello World With EMBD</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Kunal Powar -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
